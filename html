<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Team Meeting Control Center — MERGED (Artifact)</title>
  <style>
    :root {
      /* Header Gradient - Updated color */
      --header-gradient: linear-gradient(135deg, #798fca 0%, #8fa4d3 100%);
      /* Typography & Spacing */
      --font-primary: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      --font-weight-bold: 600;
      --spacing-xs: 4px;
      --spacing-sm: 8px;
      --spacing-md: 16px;
      --spacing-lg: 24px;
      --spacing-xl: 32px;
    }


    * { margin: 0; padding: 0; box-sizing: border-box; }


    body {
      font-family: var(--font-primary);
      background: var(--header-gradient);
      min-height: 100vh;
    }


    /* Step container */
    .steps-container {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 24px;
      flex-wrap: wrap;
      padding-left: 100px;
      position: relative;
    }


    /* Add arrows only for execution (sequential) */
    .steps-container--execution .step-box:not(:last-child)::after {
      content: '→';
      position: absolute;
      right: -14px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 16px;
      color: #28a745;
      font-weight: bold;
      z-index: 1;
    }


    /* Phase label - restored vertical positioning with icons */
    .phase-label {
      position: absolute;
      left: 0;
      top: 70%;
      transform: translateY(-50%) rotate(-90deg);
      background: #6c757d;
      color: white;
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: normal;
      transform-origin: center;
      margin-left: -20px;
      display: flex;
      align-items: center;
      gap: 4px;
    }


    .meeting-section--execution .phase-label { background: #4caf50; }
    .meeting-section--planning  .phase-label { background: #2196f3; }


    /* Step boxes - Exact 140×100px dimensions */
    .step-box {
      width: 140px;
      height: 100px;
      border-radius: 8px;
      border: 2px solid;
      padding: 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      box-sizing: border-box;
      transition: all 0.3s ease;
      position: relative;
      cursor: pointer;
      background: white;
      gap: 4px;
    }
    .step-box:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(0,0,0,0.15); }


    .step-box__icon   { font-size: 24px; line-height: 1; margin: 0; }
    .step-box__label  { font-size: 12px; font-weight: var(--font-weight-bold); line-height: 1.1; margin: 0; text-align: center; }
    .step-box__status { font-size: 10px; font-weight: normal; line-height: 1.1; opacity: 0.8; margin: 0; }


    /* Manual override indicator */
    .step-box--manual::before {
      content: 'M'; position: absolute; top: 4px; right: 4px;
      background: #ff9800; color: white; width: 12px; height: 12px; border-radius: 50%;
      font-size: 8px; font-weight: bold; display: flex; align-items: center; justify-content: center;
    }


    /* Step box status colors */
    .step-box--completed { border-color: #1976d2; background-color: #e3f2fd; color: #1976d2; }
    .step-box--scheduled { border-color: #388e3c; background-color: #e8f5e8; color: #388e3c; }
    .step-box--attention { border-color: #f57c00; background-color: #fff3e0; color: #f57c00; }
    .step-box--waiting   { border-color: #616161; background-color: #f5f5f5; color: #616161; }


    /* Main container - Full screen, no background */
    .dashboard-container { width: 100%; min-height: 100vh; background: var(--header-gradient); overflow: hidden; }


    /* Header */
    .dashboard-header { color: white; padding: 40px; text-align: center; }
    .dashboard-header h1 {
      font-size: 32px; font-weight: var(--font-weight-bold); margin-bottom: 8px;
      display: flex; align-items: center; justify-content: center; gap: 12px;
    }


    .header-info { display: flex; justify-content: space-between; align-items: center; font-size: 14px; opacity: 0.9; padding: 0 80px; }


    .mode-toggle {
      background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3);
      padding: 6px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; transition: all 0.3s ease;
    }
    .mode-toggle:hover { background: rgba(255,255,255,0.3); }


    /* Main content area */
    .dashboard-content { padding: 40px; background: #f8f9fa; min-height: calc(100vh - 200px); }


    /* Meeting section */
    .meeting-section { background: white; border-radius: 12px; padding: 32px; margin-bottom: 32px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); position: relative; }


    /* Section header */
    .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px; padding: 16px 0; border-bottom: 1px solid #e9ecef; }
    .section-title { font-size: 18px; font-weight: var(--font-weight-bold); color: #333; margin: 0; display: flex; align-items: center; gap: 8px; }
    .header-controls { display: flex; align-items: center; }


    .status-box {
      background: #e8f5e8; color: #2e7d32; padding: 6px 12px; border-radius: 6px;
      font-size: 12px; font-weight: var(--font-weight-bold); border: 1px solid #4caf50;
    }
    .status-box--pending   { background: #fff3cd; color: #856404; border-color: #ffeaa7; }
    .status-box--confirmed { background: #d4edda; color: #155724; border-color: #c3e6cb; }


    .archive-x {
      position: absolute; top: 16px; right: 16px; background: none; color: #333; border: none;
      width: 20px; height: 20px; font-size: 16px; cursor: pointer; transition: all 0.3s ease;
      display: flex; align-items: center; justify-content: center; font-weight: bold;
    }
    .archive-x:hover { color: #000; transform: scale(1.2); }


    /* Empty state styling */
    .empty-state { text-align: center; padding: 40px 20px; color: #6c757d; }
    .empty-state h3 { margin-bottom: 8px; color: #495057; }


    /* Quick Access Section */
    .quick-access { background: white; border-radius: 12px; padding: 32px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
    .quick-access h3 { margin-bottom: 24px; color: #333; font-size: 18px; display: flex; align-items: center; gap: 8px; }


    .quick-access-buttons { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; }
    .quick-access-button {
      padding: 12px 16px; background: #f8f9fa; color: #6c757d; text-decoration: none; border-radius: 8px;
      text-align: center; font-weight: var(--font-weight-bold); transition: all 0.3s ease; font-size: 14px; border: 1px solid #e9ecef;
    }
    .quick-access-button:hover { background: #e9ecef; transform: translateY(-1px); }


    /* Modal dialog styles */
    .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.5); display: none; justify-content: center; align-items: center; z-index: 1000;
    }
    .modal-dialog { background: white; border-radius: 12px; padding: 24px; max-width: 500px; width: 90%; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid #e9ecef; }
    .modal-title { font-size: 18px; font-weight: var(--font-weight-bold); margin: 0; }
    .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: #6c757d; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; }
    .modal-close:hover { color: #000; }
    .modal-body { margin-bottom: 20px; }
    .modal-details { background: #f8f9fa; padding: 16px; border-radius: 8px; margin: 12px 0; }
    .modal-actions { display: flex; gap: 12px; justify-content: flex-end; }
    .btn { padding: 10px 20px; border: none; border-radius: 6px; font-size: 14px; font-weight: var(--font-weight-bold); cursor: pointer; transition: all 0.3s ease; }
    .btn-primary  { background: #1a73e8; color: white; }
    .btn-primary:hover  { background: #1557b0; }
    .btn-secondary{ background: #6c757d; color: white; }
    .btn-secondary:hover{ background: #545b62; }
    .btn-danger   { background: #dc3545; color: white; }
    .btn-danger:hover   { background: #c82333; }
    .archive-reason { width: 100%; padding: 8px 12px; border: 1px solid #ced4da; border-radius: 4px; font-size: 14px; margin-top: 8px; }


    .meeting-archived { opacity: 0.5; transform: scale(0.95); transition: all 0.5s ease; pointer-events: none; }
    .meeting-archived::after {
      content: "ARCHIVED"; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      background: rgba(220, 53, 69, 0.9); color: white; padding: 8px 16px; border-radius: 4px; font-weight: bold; font-size: 18px;
    }


    /* Responsive Design */
    @media (max-width: 768px) {
      .dashboard-content { padding: 20px; }
      .meeting-section { padding: 20px; }
      .quick-access-buttons { grid-template-columns: repeat(2, 1fr); }
      .header-info { flex-direction: column; gap: 8px; }
    }
    @media (max-width: 480px) { .quick-access-buttons { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <!-- ANCHOR MAP: Search for 'ANCHOR:' in this file to jump to key sections.
       - PATCH-0-DELEGATED (JS event wiring)
       - MODAL-OVERLAY, MODAL-CLOSE-BUTTON, MODE-TOGGLE (HTML anchors)
       - SHOW-MODAL, CLOSE-MODAL, ARCHIVE, CONFIRM-ARCHIVE, EXECUTE-ACTION (JS functions)
       - CLASS-START, GS, CREATE-FALLBACK, INIT, LOAD-DATA, ENHANCE, UPDATE-HEADER, RENDER, RENDER-PHASE, RENDER-STEPS, QUICK-ACCESS (class methods)
       - INIT-DOMREADY, HANDLE-STEP (init and handler)
  -->
  <div class="dashboard-container">
    <!-- Header -->
    <header class="dashboard-header">
      <h1>📅 Team Meeting Control Center</h1>
      <div class="header-info">
        <span id="current-week-display">Loading...</span>
        <!-- ANCHOR: MODE-TOGGLE -->


        <button class="mode-toggle" id="mode-toggle">
          <span id="mode-text">Loading...</span>
        </button>
        <span id="last-updated">Loading...</span>
      </div>
    </header>


    <!-- Dashboard Content -->
    <div class="dashboard-content" id="dashboard-content"><!-- dynamic --></div>
  </div>


  <!-- Modal Dialog -->
  <!-- ANCHOR: MODAL-OVERLAY -->


  <div class="modal-overlay" id="modal-overlay">
    <div class="modal-dialog">
      <div class="modal-header">
        <h3 class="modal-title" id="modal-title">Action Preview</h3>
        <!-- PATCH-1: keep button but also support overlay click & ESC -->
        <!-- ANCHOR: MODAL-CLOSE-BUTTON -->


        <button class="modal-close" id="modal-close" type="button">×</button>
      </div>
      <div class="modal-body">
        <div id="modal-content"><!-- Dynamic content --></div>
        <div class="modal-details" id="modal-details"><!-- Action details --></div>
      </div>
      <div class="modal-actions" id="modal-actions"><!-- Action buttons --></div>
    </div>
  </div>


  <script>
    /* Diagnostics */
    window.onerror = (m,s,l,c,e)=>console.log('[HTMLERR]', m, s+':'+l, c, e?.stack||'');
    document.addEventListener('DOMContentLoaded', ()=>console.log('[BOOT] DOM ready'));// ANCHOR: PATCH-0-DELEGATED




    /* PATCH-0: Delegated UI events (no inline handlers) */
    document.addEventListener('click', (e) => {
      // Mode toggle (button or inner span)
      if (e.target.closest('#mode-toggle')) {
        toggleMode();
        return;
      }
      // Archive buttons (data-action)
      const archiveBtn = e.target.closest('[data-action="archive"]');
      if (archiveBtn) {
        archiveMeeting(archiveBtn.dataset.meetingId, archiveBtn.dataset.phase);
        return;
      }
      // Close modal
      if (e.target.closest('#modal-close')) {
        closeModal();
        return;
      }
    });
    // Close modal by clicking overlay
    document.getElementById('modal-overlay').addEventListener('click', (e) => {
      if (e.target.id === 'modal-overlay') closeModal();
    });
    // Close modal on ESC
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeModal();
    });


    /* Basic functions */
    function toggleMode() {
      const modeEl = document.getElementById('mode-text');
      if (modeEl) {
        const currentText = modeEl.textContent || '';
        modeEl.textContent = currentText.includes('TEST') ? '✨ PRODUCTION' : '🧪 TEST Mode';
      }
    }
    // ANCHOR: SHOW-MODAL




    function showModal(config) {
      document.getElementById('modal-title').textContent = config.title || 'Action';
      document.getElementById('modal-content').innerHTML = config.content || '';
      document.getElementById('modal-details').innerHTML = config.details || '';
      document.getElementById('modal-actions').innerHTML = config.actions || '';
      document.getElementById('modal-overlay').style.display = 'flex';
    }
    // ANCHOR: CLOSE-MODAL


    function closeModal() {
      const modal = document.getElementById('modal-overlay');
      if (modal) modal.style.display = 'none';
    }


    /* Archive flow (server-aware, graceful fallback) — PATCH-2 */
    // ANCHOR: ARCHIVE


    function archiveMeeting(meetingId, phase) {
      console.log('Archive requested for meeting', meetingId, 'in', phase);
      const dialogConfig = {
        title: 'Archive Meeting',
        content: '<p>Are you sure you want to archive this meeting?</p><p>This action cannot be undone. Please provide a reason:</p>',
        details: `<strong>Meeting:</strong> ${phase || 'Unknown'} meeting<br><strong>Action:</strong> Archive and remove from dashboard`,
        actions: `
          <button class="btn btn-secondary" type="button" id="archive-cancel">Cancel</button>
          <button class="btn btn-danger" type="button" id="archive-confirm" data-meeting-id="${meetingId || ''}" data-phase="${phase || ''}">Archive Meeting</button>
        `
      };
      showModal(dialogConfig);
      // Inject textarea after modal is visible
      setTimeout(() => {
        const modalContent = document.getElementById('modal-content');
        if (modalContent) {
          modalContent.insertAdjacentHTML('beforeend', '<textarea class="archive-reason" id="archive-reason" placeholder="Enter reason for archiving..." rows="3"></textarea>');
        }
        const cancelBtn = document.getElementById('archive-cancel');
        const confirmBtn = document.getElementById('archive-confirm');
        if (cancelBtn) cancelBtn.addEventListener('click', closeModal);
        if (confirmBtn) {
          confirmBtn.addEventListener('click', async () => {
            const id = confirmBtn.dataset.meetingId;
            const ph = confirmBtn.dataset.phase;
            await confirmArchive(id, ph);
          });
        }
      }, 30);
    }
    // ANCHOR: CONFIRM-ARCHIVE




    async function confirmArchive(meetingId, phase) {
      const reason = document.getElementById('archive-reason')?.value.trim();
      if (!reason) { alert('Please provide a reason for archiving.'); return; }
      try {
        const result = await window.dashboard?.gs('archiveMeetingEntity', meetingId, reason);
        if (result) {
          console.log(`Meeting ${meetingId} archived successfully`);
          alert('Meeting archived successfully');
          if (window.dashboard) await window.dashboard.loadDashboardData();
        } else {
          console.log(`Would archive meeting ${meetingId} with reason: ${reason}`);
          alert('Archive functionality not available in demo mode');
        }
      } catch (error) {
        console.error('Archive failed:', error);
        alert('Archive failed: ' + error.message);
      }
      closeModal();
    }


    /* Action execution — PATCH-3 */
    // ANCHOR: EXECUTE-ACTION


    async function executeAction(actionType, meetingId) {
      console.log('Execute action', actionType, 'for meeting', meetingId);
      try {
        if (meetingId && window.dashboard) {
          const result = await window.dashboard.gs('sendMeetingEmail', meetingId, actionType);
          if (result && result.success) {
            alert(`${actionType} executed successfully! Sent to ${result.recipients} recipients.`);
            await window.dashboard.loadDashboardData();
          } else {
            alert(`${actionType} would be executed for meeting ${meetingId}`);
          }
        } else {
          alert(`${actionType} action would be executed`);
        }
      } catch (error) {
        console.error('Action execution failed:', error);
        alert('Action failed: ' + error.message);
      }
      closeModal();
    }


    /* TeamMeetingDashboard Class — PARTIAL base with safe backend bridge */
    // ANCHOR: CLASS-START


    class TeamMeetingDashboard {
      constructor() {
        this.dashboardData = null;
        this.teamEmails = [];
        console.log('TeamMeetingDashboard constructor called');
      }


      /* PATCH-4: Backend bridge (Apps Script safe) */
      // ANCHOR: GS


      gs(fnName, ...args) {
        return new Promise((resolve) => {
          const gsRun = (window.google && google.script && google.script.run) || null;
          if (gsRun && typeof gsRun[fnName] === 'function') {
            gsRun.withSuccessHandler(resolve).withFailureHandler(() => resolve(null))[fnName](...args);
          } else {
            resolve(null);
          }
        });
      }


      /* Provided partial fallback data */
      // ANCHOR: CREATE-FALLBACK


      createFallbackData() {
        return {
          execution: {
            phase: 'EXECUTION',
            title: 'Execution (This Week)',
            meetings: [],
            status: { actionRequired: false, statusText: 'No meetings this week', level: 'INFO' }
          },
          planning: {
            phase: 'PLANNING',
            title: 'Planning (Next Week)',
            meetings: [],
            status: { actionRequired: false, statusText: 'No meeting planned', level: 'INFO' }
          },
          currentWeek: { displayText: 'Week of ' + new Date().toLocaleDateString() },
          testMode: true,
          lastUpdated: new Date().toLocaleString()
        };
      }


      /* Small init that calls loader */
      // ANCHOR: INIT


      init() {
        console.log('Dashboard initializing...');
        this.loadDashboardData();
      }


      /* PATCH-5: Server-first load with graceful fallbacks */
      // ANCHOR: LOAD-DATA


      async loadDashboardData() {
        try {
          const serverData = await this.gs('getDashboardData');
          this.dashboardData = serverData || this.createFallbackData();


          const serverTeam = await this.gs('getAllTeamEmails', true);
          this.teamEmails = Array.isArray(serverTeam) && serverTeam.length
            ? serverTeam
            : ['rkrochek@myteamli.com'];


          // PATCH-5a: No-op enhance until step system is added
          if (typeof this.enhanceMeetingData === 'function') this.enhanceMeetingData();
          console.log('Dashboard data loaded:', this.dashboardData);
          this.updateHeaderInfo();
          this.renderDashboard();
        } catch (error) {
          console.error('Failed to load dashboard data:', error);
          this.dashboardData = this.createFallbackData();
          this.teamEmails = ['rkrochek@myteamli.com'];
          this.updateHeaderInfo();
          this.renderDashboard();
        }
      }


      /* No-op enhancer placeholder to avoid runtime errors (can be replaced by Patch-3 later) */
      // ANCHOR: ENHANCE


      enhanceMeetingData() {
        try {
          const phases = ['execution', 'planning'];
          phases.forEach((phase) => {
            const section = this.dashboardData && this.dashboardData[phase];
            if (section && Array.isArray(section.meetings)) {
              section.meetings = section.meetings.map((meeting) => {
                const daysUntil = this.calculateDaysUntil(meeting?.date);
                return {
                  ...meeting,
                  daysUntil,
                  progress: this.calculateStepProgress(meeting, phase, daysUntil),
                };
              });
            }
          });
        } catch (err) {
          console.warn('enhanceMeetingData error:', err);
        }
      }


      // ANCHOR: CALC-DAYS-UNTIL
      calculateDaysUntil(dateStr) {
        try {
          if (!dateStr) return 9999;
          const today = new Date();
          const t0 = new Date(today.getFullYear(), today.getMonth(), today.getDate());
          const d = new Date(dateStr);
          const d0 = new Date(d.getFullYear(), d.getMonth(), d.getDate());
          return Math.round((d0 - t0) / 86400000);
        } catch (_) {
          return 9999;
        }
      }


      // ANCHOR: FORMAT-DATE
      formatDate(dateStr) {
        try { return new Date(dateStr).toLocaleDateString(); } catch (_) { return String(dateStr || ''); }
      }


      // ANCHOR: STEP-PROGRESS
      calculateStepProgress(meeting, phase, daysUntil) {
        if (phase === 'execution') {
          return {
            steps: [
              { key: 'CONFIRMATION', label: 'Leader Confirmation', completed: !!meeting?.confirmedAt,     status: this.getStepStatus(meeting?.confirmedAt, daysUntil, 7),  manual: meeting?.confirmedAt === 'MANUAL' },
              { key: 'REMINDER',     label: 'Team Reminder',       completed: !!meeting?.reminderSentAt,  status: this.getStepStatus(meeting?.reminderSentAt, daysUntil, 3), manual: meeting?.reminderSentAt === 'MANUAL' },
              { key: 'AGENDA',       label: 'Agenda Distribution', completed: !!meeting?.agendaDistributedAt, status: this.getStepStatus(meeting?.agendaDistributedAt, daysUntil, 0), manual: meeting?.agendaDistributedAt === 'MANUAL' },
              { key: 'MEETING',      label: 'Meeting Status',      completed: daysUntil < 0,              status: this.getMeetingTimingStatus(daysUntil), manual: false },
              { key: 'FOLLOWUP',     label: 'Follow-up',           completed: !!meeting?.followupSentAt,  status: this.getStepStatus(meeting?.followupSentAt, daysUntil, -1), manual: meeting?.followupSentAt === 'MANUAL' },
            ],
          };
        }
        // planning
        return {
          steps: [
            { key: 'MEETING_PLANNED', label: 'Meeting Planned',        completed: true,                   status: `Planned ${this.formatDate(meeting?.date)}`, manual: false },
            { key: 'LEADER_STATUS',   label: 'Leader Assignment',      completed: !!meeting?.leader,      status: meeting?.leaderName || meeting?.leader || 'Unknown', manual: false },
            { key: 'AGENDA_ITEMS',    label: 'Agenda Collection',      completed: Array.isArray(meeting?.agendaItems) ? meeting.agendaItems.length > 0 : !!meeting?.agendaCount, status: this.getAgendaItemsStatus(meeting), manual: false },
            { key: 'DAYS_UNTIL',      label: 'Days Until',             completed: false,                  status: daysUntil > 1 ? `${daysUntil} days` : (daysUntil === 1 ? 'Tomorrow' : (daysUntil === 0 ? 'Today' : `${Math.abs(daysUntil)} day(s) ago`)), manual: false },
            { key: 'READY_STATUS',    label: 'Ready Status',           completed: false,                  status: this.getReadinessStatus(meeting), manual: false },
          ],
        };
      }


      // ANCHOR: GET-STEP-STATUS
      getStepStatus(stamp, daysUntil, targetOffset) {
        if (stamp && stamp !== 'MANUAL' && stamp !== true) {
          return `Done ${this.formatDate(stamp)}`;
        }
        if (stamp === 'MANUAL' || stamp === true) return 'Marked done (manual)';
        const delta = daysUntil - (Number.isFinite(targetOffset) ? targetOffset : 0);
        if (delta > 1) return `Scheduled in ${delta} days`;
        if (delta === 1) return 'Scheduled tomorrow';
        if (delta === 0) return 'Due today';
        return `Overdue by ${Math.abs(delta)} day${Math.abs(delta) === 1 ? '' : 's'}`;
      }


      // ANCHOR: GET-MEETING-TIMING-STATUS
      getMeetingTimingStatus(daysUntil) {
        if (daysUntil > 1) return `${daysUntil} days`;
        if (daysUntil === 1) return 'Tomorrow';
        if (daysUntil === 0) return 'Today';
        return `${Math.abs(daysUntil)} day(s) ago`;
      }


      // ANCHOR: GET-AGENDA-STATUS
      getAgendaItemsStatus(meeting) {
        const count = Array.isArray(meeting?.agendaItems) ? meeting.agendaItems.length : (meeting?.agendaCount || 0);
        return count ? `${count} item${count === 1 ? '' : 's'}` : 'No items yet';
      }


      // ANCHOR: GET-READY-STATUS
      getReadinessStatus(meeting) {
        const hasLeader = !!(meeting?.leader || meeting?.leaderName);
        const hasAgenda = Array.isArray(meeting?.agendaItems) ? meeting.agendaItems.length > 0 : !!meeting?.agendaCount;
        if (hasLeader && hasAgenda) return 'Ready';
        if (hasLeader && !hasAgenda) return 'Add agenda items';
        if (!hasLeader && hasAgenda) return 'Assign leader';
        return 'Needs leader & agenda';
      }
      // ANCHOR: UPDATE-HEADER




      updateHeaderInfo() {
        if (!this.dashboardData) return;
        // Update header information with real data
        const currentWeekEl = document.getElementById('current-week-display');
        const modeEl = document.getElementById('mode-text');
        const updatedEl = document.getElementById('last-updated');

        if (currentWeekEl) {
          currentWeekEl.textContent = `Current week: ${this.dashboardData.currentWeek?.displayText || 'Unknown'}`;
        }
        if (modeEl) {
          const modeText = this.dashboardData.testMode ? '🧪 TEST Mode' : '✨ PRODUCTION';
          modeEl.textContent = modeText;
        }
        if (updatedEl) {
          updatedEl.textContent = `Updated: ${this.dashboardData.lastUpdated || new Date().toLocaleString()}`;
        }
      }
      // ANCHOR: RENDER




      renderDashboard() {
        const container = document.getElementById('dashboard-content');
        if (!container) return;


        let html = '';
        html += this.renderEmptyPhase(this.dashboardData.execution, 'execution');
        html += this.renderEmptyPhase(this.dashboardData.planning,  'planning');
        html += this.renderQuickAccess();


        container.innerHTML = html;
        console.log('Dashboard rendered');
      }
      // ANCHOR: RENDER-PHASE




      renderEmptyPhase(phaseData, phaseType) {
        const emptyMessage = phaseType === 'planning'
          ? 'No meeting planned - ready to schedule'
          : 'No meetings this week';
        const phaseIcon  = (phaseType === 'execution') ? '🚀' : '📋';
        const phaseLabel = (phaseType === 'execution') ? 'EXECUTION' : 'PLANNING';
        const flowClass  = (phaseType === 'execution') ? 'steps-container--execution' : 'steps-container--planning';


        return `
          <section class="meeting-section meeting-section--${phaseType}">
            <div class="section-header">
              <h2 class="section-title">${phaseData.title || 'Unknown Phase'}</h2>
              <div class="header-controls">
                <div class="status-box status-box--pending">⏳ ${emptyMessage}</div>
              </div>
            </div>
            <div class="steps-container ${flowClass}">
              <div class="phase-label">
                <div class="phase-icon">${phaseIcon}</div>
                <div class="phase-text">${phaseLabel}</div>
              </div>
              ${this.renderPhaseSteps(phaseData, phaseType)}
            </div>
          </section>
        `;
      }
      // ANCHOR: RENDER-STEPS




      renderDefaultSteps(phaseType) {
        if (phaseType === 'execution') {
          return `
            <div class="step-box step-box--waiting" data-status="WAITING" data-step="CONFIRMATION" data-meeting-id="" data-phase="${phaseType}">
              <div class="step-box__icon">📧</div>
              <div class="step-box__label">Leader Confirmation</div>
              <div class="step-box__status">Awaiting plan</div>
            </div>
            <div class="step-box step-box--waiting" data-status="WAITING" data-step="REMINDER" data-meeting-id="" data-phase="${phaseType}">
              <div class="step-box__icon">📢</div>
              <div class="step-box__label">Team Reminder</div>
              <div class="step-box__status">Awaiting plan</div>
            </div>
            <div class="step-box step-box--waiting" data-status="WAITING" data-step="AGENDA" data-meeting-id="" data-phase="${phaseType}">
              <div class="step-box__icon">📋</div>
              <div class="step-box__label">Meeting Agenda</div>
              <div class="step-box__status">Awaiting plan</div>
            </div>
            <div class="step-box step-box--waiting" data-status="WAITING" data-step="MEETING" data-meeting-id="" data-phase="${phaseType}">
              <div class="step-box__icon">🎯</div>
              <div class="step-box__label">Meeting</div>
              <div class="step-box__status">Awaiting plan</div>
            </div>
            <div class="step-box step-box--waiting" data-status="WAITING" data-step="FOLLOWUP" data-meeting-id="" data-phase="${phaseType}">
              <div class="step-box__icon">📬</div>
              <div class="step-box__label">Follow-up</div>
              <div class="step-box__status">Awaiting plan</div>
            </div>
          `;
        } else {
          return `
            <div class="step-box step-box--waiting" data-status="WAITING" data-step="MEETING_PLANNED" data-meeting-id="" data-phase="${phaseType}">
              <div class="step-box__icon">📅</div>
              <div class="step-box__label">Meeting Planned</div>
              <div class="step-box__status">Click to plan</div>
            </div>
            <div class="step-box step-box--waiting" data-status="WAITING" data-step="LEADER_STATUS" data-meeting-id="" data-phase="${phaseType}">
              <div class="step-box__icon">👤</div>
              <div class="step-box__label">Leader Assignment</div>
              <div class="step-box__status">Awaiting plan</div>
            </div>
            <div class="step-box step-box--waiting" data-status="WAITING" data-step="AGENDA_ITEMS" data-meeting-id="" data-phase="${phaseType}">
              <div class="step-box__icon">📝</div>
              <div class="step-box__label">Agenda Collection</div>
              <div class="step-box__status">Awaiting plan</div>
            </div>
            <div class="step-box step-box--waiting" data-status="WAITING" data-step="DAYS_UNTIL" data-meeting-id="" data-phase="${phaseType}">
              <div class="step-box__icon">⏰</div>
              <div class="step-box__label">Days Until</div>
              <div class="step-box__status">--</div>
            </div>
            <div class="step-box step-box--waiting" data-status="WAITING" data-step="READY_STATUS" data-meeting-id="" data-phase="${phaseType}">
              <div class="step-box__icon">✅</div>
              <div class="step-box__label">Ready for Next Week</div>
              <div class="step-box__status">Awaiting plan</div>
            </div>
          `;
        }
      }
      // ANCHOR: RENDER-PHASE-STEPS
      renderPhaseSteps(phaseData, phaseType) {
        try {
          if (phaseData && Array.isArray(phaseData.meetings) && phaseData.meetings.length) {
            const meeting = phaseData.meetings[0]; // display first meeting for now
            const steps = meeting?.progress?.steps || [];
            if (!steps.length) return this.renderDefaultSteps(phaseType);
            return this.renderStepsFromProgress(steps, meeting, phaseType);
          }
        } catch (e) { console.warn('renderPhaseSteps error', e); }
        return this.renderDefaultSteps(phaseType);
      }


      // ANCHOR: RENDER-STEPS-FROM-PROGRESS
      renderStepsFromProgress(steps, meeting, phaseType) {
        const ICONS = {
          CONFIRMATION: '📧', REMINDER: '📢', AGENDA: '📋', MEETING: '🎯', FOLLOWUP: '📬',
          MEETING_PLANNED: '📅', LEADER_STATUS: '👤', AGENDA_ITEMS: '📝', DAYS_UNTIL: '⏰', READY_STATUS: '✅'
        };
        return steps.map((step) => {
          const status = String(step.status || '').trim();
          let cls = 'step-box step-box--waiting';
          if (step.completed) cls = 'step-box step-box--completed';
          else if (/Due today|Overdue/i.test(status)) cls = 'step-box step-box--attention';
          else if (/Scheduled|days|Tomorrow/i.test(status)) cls = 'step-box step-box--scheduled';
          const manualCls = step.manual ? ' step-box--manual' : '';
          const mid = meeting?.meetingId || meeting?.id || '';
          return `
            <div class="${cls}${manualCls}" data-status="${step.completed ? 'COMPLETED' : 'PENDING'}" data-step="${step.key}" data-meeting-id="${mid}" data-phase="${phaseType}">
              <div class="step-box__icon">${ICONS[step.key] || '🔘'}</div>
              <div class="step-box__label">${step.label}</div>
              <div class="step-box__status">${status}</div>
            </div>
          `;
        }).join('\n');
      }


      // ANCHOR: QUICK-ACCESS




      renderQuickAccess() {
        return `
          <section class="quick-access">
            <h3>🔗 Quick Access</h3>
            <div class="quick-access-buttons">
              <a href="#" class="quick-access-button">👥 Team Rotation</a>
              <a href="#" class="quick-access-button">📝 Agenda Form</a>
              <a href="#" class="quick-access-button">📚 Meeting History</a>
              <a href="#" class="quick-access-button">📋 Agenda Template</a>
            </div>
          </section>
        `;
      }
    }

    /* Initialize */
    document.addEventListener('DOMContentLoaded', () => {
      window.dashboard = new TeamMeetingDashboard();  // ← This line is missing or broken
        console.log('Dashboard assigned:', window.dashboard); // ← ADD THIS LINE
      window.dashboard.init();


      /* PATCH-6: Step box click → modal */
      document.addEventListener('click', (e) => {
        const stepBox = e.target.closest('.step-box');
        if (stepBox) {
          const stepKey  = stepBox.dataset.step;
          const meetingId = stepBox.dataset.meetingId;
          const phase    = stepBox.dataset.phase;
          handleStepClick(stepKey, meetingId, phase);
        }
      });
    });
    // ANCHOR: HANDLE-STEP

    function handleStepClick(stepKey, meetingId, phase) {
      console.log(`Step clicked: ${stepKey} for meeting ${meetingId} in ${phase}`);
      const dialogConfig = {
        title: `${stepKey.replace('_', ' ')} Action`,
        content: `<p>Execute ${stepKey.toLowerCase().replace('_', ' ')} action?</p>`,
        details: `<strong>Phase:</strong> ${phase?.toUpperCase() || 'UNKNOWN'}<br><strong>Action:</strong> ${stepKey}`,
        actions: `
          <button class="btn btn-secondary" type="button" id="action-cancel">Cancel</button>
          <button class="btn btn-primary" type="button" id="action-execute" data-step="${stepKey}" data-meeting-id="${meetingId || ''}">Execute</button>
        `
      };
      showModal(dialogConfig);
      setTimeout(() => {
        const cancel = document.getElementById('action-cancel');
        const exec   = document.getElementById('action-execute');
        if (cancel) cancel.addEventListener('click', closeModal);
        if (exec) exec.addEventListener('click', async () => {
          const step = exec.dataset.step;
          const id   = exec.dataset.meetingId;
          await executeAction(step, id);
        });
      }, 20);
    }
  </script>
</body>
</html>



